from fastapi import FastAPI, HTTPException
from fastapi.middleware.cors import CORSMiddleware
from pydantic import BaseModel
import httpx
import os
from datetime import datetime

app = FastAPI(title="LinkGuard API")

# CORS
app.add_middleware(
    CORSMiddleware,
    allow_origins=["*"],
    allow_credentials=True,
    allow_methods=["*"],
    allow_headers=["*"],
)

# Models
class LinkCheck(BaseModel):
    url: str

class LinkResponse(BaseModel):
    url: str
    healthy: bool
    status: int
    reason: str
    checked_at: str

# Health check
@app.get("/")
async def root():
    return {"status": "LinkGuard API is running", "version": "1.0.0"}

@app.get("/health")
async def health():
    return {"status": "healthy", "timestamp": datetime.utcnow().isoformat()}

# Link checker
@app.post("/api/check-link", response_model=LinkResponse)
async def check_link(link: LinkCheck):
    try:
        async with httpx.AsyncClient(timeout=10.0) as client:
            response = await client.head(link.url, follow_redirects=True)
            status = response.status_code
            
            is_healthy = 200 <= status < 400
            reason = "Healthy" if is_healthy else f"HTTP {status}"
            
            return LinkResponse(
                url=link.url,
                healthy=is_healthy,
                status=status,
                reason=reason,
                checked_at=datetime.utcnow().isoformat()
            )
    except Exception as e:
        return LinkResponse(
            url=link.url,
            healthy=False,
            status=0,
            reason="Connection Error",
            checked_at=datetime.utcnow().isoformat()
        )

if __name__ == "__main__":
    import uvicorn
    uvicorn.run(app, host="0.0.0.0", port=int(os.getenv("PORT", 8000)))